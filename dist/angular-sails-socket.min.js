/*
 * @license Angular DOM
 * (c) 2015 Bethel Technologies, LLC http://getbethel.com
 * License: MIT
 */
!function(a){"use strict";a.module("bethel.sailsSocket",[]).service("sailsSocket",["$q","$rootScope",function(b,c){if(!io.socket)throw new Error("Missing required `sails.io.js` dependency.");c.sailsSocket={_csrf:"",outstanding:0};var d=function(b,d,e){"/"!==b[0]&&(b="/".concat(b)),c.sailsSocket.outstanding++;var f=e?[]:{};return io.socket.get(b,d,function(b){a.forEach(b,function(a,b){e?f.push(a):f[b]=a}),c.sailsSocket.outstanding--,c.$digest()}),f};this.get=function(a){return b(function(b,c){io.socket.get(a,function(a,d){return d.statusCode<400?b(a):c(a)})})},this.populateOne=function(a,b){return d(a,b)},this.populateMany=function(a,b){return d(a,b,!0)},this.post=function(a,d){return d._csrf=c.sailsSocket._csrf,b(function(b,c){io.socket.post(a,d,function(a,d){return d.statusCode<400?b(a):c(a)})})},this.put=function(a,d){return d._csrf=c.sailsSocket._csrf,b(function(b,c){io.socket.put(a,d,function(a,d){return d.statusCode<400?b(a):c(a)})})},this.get("/csrfToken").then(function(a){c.sailsSocket._csrf=a._csrf}),this.editable=function(b,d,e,f){f=f||function(){},b.$watch(d,function(g,h){if(g&&h){for(var i={},j=0,k=e.length;k>j;j++){var l=e[j];a.isUndefined(g[l])||a.isDefined(h[l])&&g[l].toString()===h[l].toString()||(i[l]=g[l])}Object.keys(i).length<=0||(i._csrf=c.sailsSocket._csrf,io.socket.put("/"+d+"/"+b[d].id,i,f))}},!0)};var e=function(b,c){var d=null;return a.forEach(b,function(a,b){a.id===c&&(d=b)}),d};this.sync=function(a,b,c){return Array.isArray(a)?this.syncMany(a,b,c):void this.syncOne(a,b,c)},this.syncOne=function(a,b,d){io.socket.on(b,function(b){if(a.id===b.id&&"updated"===b.verb){for(var e in b.data)if(b.data.hasOwnProperty(e)){if("_csrf"===e)continue;a[e]=b.data[e]}c.$apply(),"function"==typeof d&&d()}})},this.syncMany=function(b,d,f){io.socket.on(d,function(d){switch(d.verb){case"created":if(null!==e(b,d.id))return;b.unshift(d.data);break;case"destroyed":var g=e(b,d.id);null!==g&&b.splice(g,1);break;case"updated":var h=e(b,d.id);null!==h&&a.extend(b[h],d.data);break;default:return console.log("Unhandled socket action: "+d.verb)}c.$apply(),"function"==typeof f&&f()})}}])}(angular);